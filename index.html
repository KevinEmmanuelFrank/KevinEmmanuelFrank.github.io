<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Musical IEBLA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        button:active { transform: scale(0.95); }
        .nav-btn { -webkit-tap-highlight-color: transparent; }
        .drag-over { border: 2px dashed #3b82f6 !important; background: #eff6ff !important; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-2 md:p-8 text-slate-900">

    <div class="max-w-4xl mx-auto bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-200">
        
        <!-- HEADER -->
        <header class="bg-slate-900 p-5 md:p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center shrink-0 shadow-lg shadow-blue-500/20">
                    <svg viewBox="0 0 24 24" class="w-7 h-7 text-white" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18V5l12-2v13"></path>
                        <circle cx="6" cy="18" r="3"></circle>
                        <circle cx="18" cy="16" r="3"></circle>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter leading-none">IEBLA</h1>
                    <p class="text-blue-400 text-[9px] uppercase tracking-[0.2em] font-bold mt-1">Agenda Musical</p>
                </div>
            </div>

            <div class="flex items-center gap-2 w-full md:w-auto">
                <select id="monthSelect" class="flex-1 md:flex-none bg-slate-800 text-white text-xs px-4 py-2.5 rounded-xl outline-none border-none cursor-pointer hover:bg-slate-700 transition-colors">
                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                    <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                    <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                    <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                </select>
                
                <div class="flex gap-2">
               <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-green-900/40 hidden">
    PNG
</button>
                    <button id="toggleModeBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-blue-900/40">
                        Editar
                    </button>
                </div>
            </div>
        </header>

        <!-- NAVEGACI√ìN -->
        <nav class="bg-white border-b border-slate-100 px-4 py-4 flex justify-between items-center gap-2">
            <button id="prevSunday" class="nav-btn w-12 h-12 flex items-center justify-center bg-slate-50 hover:bg-slate-100 rounded-2xl transition-colors text-slate-400 active:text-blue-600 shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
            </button>
            
            <div class="flex flex-col items-center flex-1">
                <div id="syncStatus" class="flex gap-1.5 items-center text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-slate-300"></div> Conectando...
                </div>
                <div class="flex items-baseline gap-1">
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Dom</span>
                    <span id="navDateDisplay" class="text-3xl font-black tabular-nums text-slate-900 leading-none">-</span>
                </div>
            </div>

            <button id="nextSunday" class="nav-btn w-12 h-12 flex items-center justify-center bg-slate-50 hover:bg-slate-100 rounded-2xl transition-colors text-slate-400 active:text-blue-600 shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
            </button>
        </nav>

        <!-- CONTENIDO PRINCIPAL -->
        <main id="contentArea" class="p-5 md:p-12 min-h-[400px] bg-white">
            <div class="flex items-center justify-center h-full">
                <p class="text-slate-400 animate-pulse">Cargando agenda...</p>
            </div>
        </main>

        <footer class="bg-slate-50 border-t border-slate-100 p-6 text-center">
            <p id="todayLabel" class="text-[9px] text-slate-400 font-bold uppercase tracking-[0.3em] mb-1"></p>
            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-[0.3em]">IEBLA ‚Ä¢ 2026</p>
        </footer>
    </div>

    <!-- Firebase SDK v11 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // Configuraci√≥n unificada
        const firebaseConfig = {
            apiKey: "AIzaSyB4dnDnojGL8NNMSxRJFV4eVQvKUkdoKJM",
            authDomain: "agenda-iebla.firebaseapp.com",
            projectId: "agenda-iebla",
            storageBucket: "agenda-iebla.firebasestorage.app",
            messagingSenderId: "94924538907",
            appId: "1:94924538907:web:861e69bbf351973f7de4be",
            measurementId: "G-4L3GNF3SY6"
        };

        // Estado de la App
       const AppState = {
    viewMode: 'view',
    currentMonth: new Date().getMonth(),
    activeIdx: 0,
    monthData: {},
    sundays: [],
    unsubscribe: null,
    isSaving: false,
    appId: typeof __app_id !== 'undefined' ? __app_id : 'agenda-musical-iebla-v21',
    user: null,
    musiciansList: [  // ‚Üê üÜï ESTO ES LO NUEVO
        "Kevin (direcci√≥n/voz)", "Norma (direcci√≥n/voz)", "Nataly (direcci√≥n/voz)", 
        "Gabriel (bater√≠a)","Anderson (bater√≠a)", "David (bajo)", "Lore (teclado/bajo)", "Magali (teclado)", "Thiago (teclado)",
        "Pame (proyecci√≥n)", "Nico (proyecci√≥n)", "Sonia (proyecci√≥n)", "Emma (guitarra)", "Kevin (guitarra)",
        "Pedro (sonido)", "Cristian (sonido)", "Nestor (sonido)", "Ari (voz apoyo)", "Fernando (voz apoyo)", "Meli (voz apoyo)", "Iara (voz apoyo)"
    ]
};

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        let db, auth;

        // Inicializar Firebase
        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                // Autenticaci√≥n an√≥nima para cumplir con las reglas de seguridad
                const cred = await signInAnonymously(auth);
                AppState.user = cred.user;
                
                setupInitialState();
                setupEventListeners();
                setupRealtimeListener();
                updateTodayLabel();
            } catch (error) {
                console.error("Error de inicializaci√≥n:", error);
                document.getElementById('contentArea').innerHTML = `<p class="text-red-500 text-center">Error al conectar: ${error.message}</p>`;
            }
        }

        function setupInitialState() {
            const hoy = new Date();
            AppState.sundays = getSundays(AppState.currentMonth);
            const hoyISO = hoy.toISOString().split('T')[0];
            
            // Buscar el domingo m√°s cercano (hoy o futuro)
            AppState.activeIdx = AppState.sundays.findIndex(s => s >= hoyISO);

            if (AppState.activeIdx === -1) {
                // Si no hay domingos restantes este mes, ir al siguiente
                if (AppState.currentMonth < 11) {
                    AppState.currentMonth++;
                    AppState.sundays = getSundays(AppState.currentMonth);
                    AppState.activeIdx = 0;
                } else {
                    AppState.activeIdx = AppState.sundays.length - 1;
                }
            }
            document.getElementById('monthSelect').value = AppState.currentMonth;
        }

        function getSundays(month) {
            const year = 2026;
            const date = new Date(year, month, 1);
            const found = [];
            while (date.getMonth() === month) {
                if (date.getDay() === 0) found.push(new Date(date).toISOString().split('T')[0]);
                date.setDate(date.getDate() + 1);
            }
            return found;
        }

        function setupEventListeners() {
            document.getElementById('prevSunday').addEventListener('click', () => {
                if (AppState.activeIdx > 0) { AppState.activeIdx--; render(); }
            });

            document.getElementById('nextSunday').addEventListener('click', () => {
                if (AppState.activeIdx < AppState.sundays.length - 1) { AppState.activeIdx++; render(); }
            });

            document.getElementById('toggleModeBtn').addEventListener('click', toggleMode);
            document.getElementById('monthSelect').addEventListener('change', changeMonth);
          document.getElementById('exportBtn').addEventListener('click', exportImage);
    document.addEventListener('click', (e) => {
        if (e.target.id === 'manualSaveBtn') manualSave();
    });
        }

        function setupRealtimeListener() {
            if (AppState.unsubscribe) AppState.unsubscribe();
            if (!AppState.user) return;

            const monthKey = `2026-${AppState.currentMonth}`;
            const status = document.getElementById('syncStatus');
            status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></div> Sincronizando...';

            // Ruta de Firestore siguiendo la Regla 1 (Public Data)
            const docRef = doc(db, 'artifacts', AppState.appId, 'public', 'data', 'months', monthKey);

            AppState.unsubscribe = onSnapshot(docRef, 
                (snapshot) => {
                    AppState.monthData = snapshot.exists() ? snapshot.data() : {};
                    render();
                    status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.4)]"></div> Online';
                },
                (error) => {
                    console.error("Error en listener:", error);
                    status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> Error de red';
                }
            );
        }

        function render() {
            const dateKey = AppState.sundays[AppState.activeIdx];
            if (!dateKey) {
                document.getElementById('navDateDisplay').innerText = "-";
                return;
            };

            ensureData(dateKey);
            const data = AppState.monthData[dateKey];
            const dayNum = new Date(dateKey + "T12:00:00").getDate();

            document.getElementById('navDateDisplay').innerText = dayNum;
            document.getElementById('exportBtn').classList.toggle('hidden', AppState.viewMode !== 'view');

            const container = document.getElementById('contentArea');
            container.innerHTML = getContentHTML(data, dayNum);
        }

        function ensureData(dateKey) {
            if (!AppState.monthData[dateKey]) {
                AppState.monthData[dateKey] = { musicians: [], songs: [], notes: ''  };
            }
        }

        function getContentHTML(data, dayNum) {
            const monthLabel = monthNames[AppState.currentMonth];
            if (AppState.viewMode === 'view') {
                return `
                <div class="fade-in">
                    <div class="text-center mb-10">
                        <h2 class="text-5xl font-black text-slate-900 tracking-tighter mb-1">${dayNum}</h2>
                        <p class="text-blue-600 font-bold uppercase tracking-widest text-xs">${monthLabel}</p>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-blue-50/50 rounded-3xl p-6 border border-blue-100">
                            <h3 class="text-blue-800 font-black mb-4 flex items-center gap-2 text-xs uppercase tracking-widest">üé∏ Equipo Musical</h3>
                            <div class="flex flex-wrap gap-2">
                                ${data.musicians.length ? data.musicians.map(m => `<span class="bg-white px-4 py-2 rounded-xl shadow-sm border border-blue-100 text-slate-700 font-bold text-sm">${m}</span>`).join('') : '<p class="text-slate-400 italic text-xs w-full text-center">Sin asignar</p>'}
                            </div>
                        </div>
                        <div class="bg-purple-50/50 rounded-3xl p-6 border border-purple-100">
                            <h3 class="text-purple-800 font-black mb-4 flex items-center gap-2 text-xs uppercase tracking-widest">üé§ Canciones</h3>
                            <ul class="space-y-2">
                                ${data.songs.length ? data.songs.map((s, i) => `<li class="bg-white p-4 rounded-xl shadow-sm border border-purple-100 text-slate-700 font-bold text-sm flex items-center gap-3"><span class="text-purple-300 italic text-[10px]">${i+1}</span> ${s}</li>`).join('') : '<p class="text-slate-400 italic text-xs text-center w-full">Sin canciones</p>'}
                            </ul>
                        </div>
                    </div>
                                            <!-- üÜï NOTAS EN VISTA NORMAL -->
                        <div class="bg-amber-50/50 rounded-3xl p-6 border border-amber-100 mt-6">
                            <h3 class="text-amber-800 font-black mb-4 flex items-center gap-2 text-xs uppercase tracking-widest">üìù Notas Predicador</h3>
                            <p class="text-slate-700 text-sm whitespace-pre-wrap leading-relaxed">${data.notes || 'Sin notas'}</p>
                        </div>

                </div>`;
           } else {
    return `
    <div class="fade-in space-y-8">
        ${editSectionHTML('M√∫sicos', 'musicians', data.musicians, 'üé∏')}
        ${editSectionHTML('Canciones', 'songs', data.songs, 'üé§')}
     ${editNotesSectionHTML(data.notes || '')}
<div id="saveSection" class="pt-8 border-t border-slate-200 text-center">
    <button id="manualSaveBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-2xl text-sm font-black uppercase tracking-wider shadow-xl shadow-emerald-500/25 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
        ‚úÖ Guardado Confirmado
    </button>
    <p class="text-xs text-slate-500 mt-2 font-medium">Datos sincronizados con Firebase</p>
</div>
    </div>`;
}

        }

      function editSectionHTML(title, type, items, emoji) {
    if (type === 'musicians') {
        // üÜï CHECKBOXES para m√∫sicos
        return `
            <section>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-black text-slate-800 uppercase text-[10px] tracking-widest flex items-center gap-2">${emoji} ${title}</h3>
                </div>
                <div class="bg-blue-50 rounded-3xl p-6 border border-blue-100 max-h-80 overflow-y-auto">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        ${AppState.musiciansList.map((musician, i) => {
                            const checked = items.includes(musician) ? 'checked' : '';
                            return `
                                <label class="flex items-center gap-3 p-3 bg-white rounded-xl shadow-sm border border-blue-100 hover:shadow-md transition-all cursor-pointer group">
                                    <input type="checkbox" 
                                        data-musician="${musician}" 
                                        data-field="musicians"
                                        class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500" 
                                        ${checked}>
                                    <span class="text-sm font-medium text-slate-700 group-hover:text-blue-800">${musician}</span>
                                </label>`;
                        }).join('')}
                    </div>
                    <p class="text-xs text-blue-600 mt-4 font-bold">
                        Seleccionados: <span id="musicianCount">${items.length}</span>/12
                    </p>
                </div>
            </section>`;
    } else {
        // Canciones (drag&drop normal)
        const color = type === 'songs' ? 'purple' : 'blue';
        const isDraggable = type === 'songs';
        return `
            <section>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-black text-slate-800 uppercase text-[10px] tracking-widest flex items-center gap-2">${emoji} ${title}</h3>
                    <button id="add-${type}" class="bg-${color}-600 text-white w-10 h-10 rounded-xl font-bold text-lg shadow-lg transition-all active:scale-95 hover:bg-${color}-700">+</button>
                </div>
                <div class="space-y-2" id="list-${type}" data-type="${type}">
                    ${items.map((item, i) => `
                        <div class="flex gap-2 group items-center p-2 bg-slate-50 rounded-xl border border-slate-200" 
                             ${isDraggable ? `draggable="true"` : ''} data-index="${i}">
                            ${isDraggable ? `<div class="cursor-grab text-slate-300 px-1 hover:text-slate-500">‚†ø</div>` : '<div class="w-2"></div>'}
                            <input type="text" value="${item}" data-idx="${i}" data-field="${type}"
                                placeholder="Escribir..." class="flex-1 p-2 bg-transparent border-none outline-none text-sm font-medium focus:font-bold text-slate-700">
                            <button data-del-type="${type}" data-del-idx="${i}" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    `).join('')}
                </div>
            </section>`;
    }
}


        function editNotesSectionHTML(notes) {
    return `
        <section class="mt-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-slate-800 uppercase text-[10px] tracking-widest flex items-center gap-2">üìù Notas Predicador</h3>
            </div>
            <div class="bg-amber-50 rounded-3xl p-6 border border-amber-100">
                <textarea data-field="notes" data-idx="0" 
                    placeholder="Mensaje principal, vers√≠culos clave, orden del culto..." 
                    class="w-full p-4 bg-white rounded-xl border border-amber-100 resize-vertical min-h-[120px] text-sm font-medium focus:font-bold text-slate-700 outline-none">${notes}</textarea>
            </div>
        </section>
    `;
}


        // Delegaci√≥n de eventos para edici√≥n din√°mica
        document.addEventListener('click', (e) => {
            if (e.target.id === 'add-musicians') addItem('musicians');
            if (e.target.id === 'add-songs') addItem('songs');
            
            const delBtn = e.target.closest('[data-del-type]');
            if (delBtn) {
                const type = delBtn.dataset.delType;
                const idx = parseInt(delBtn.dataset.delIdx);
                removeItem(type, idx);
            }
        });

  document.addEventListener('change', (e) => {
    if (e.target.dataset.field) {
        const field = e.target.dataset.field;
        const dateKey = AppState.sundays[AppState.activeIdx];
        
        if (field === 'notes') {
            AppState.monthData[dateKey][field] = e.target.value;
        } else if (field === 'musicians') {
            // üÜï CHECKBOXES M√öSICOS
            const checkboxes = document.querySelectorAll('input[data-field="musicians"]');
            const selectedMusicians = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.musician);
            AppState.monthData[dateKey][field] = selectedMusicians;
            
            // Actualizar contador
            document.getElementById('musicianCount').textContent = selectedMusicians.length;
        } else {
            const idx = parseInt(e.target.dataset.idx);
            AppState.monthData[dateKey][field][idx] = e.target.value;
        }
        debouncedSave();
    }
});



        // Funciones de acci√≥n
        function addItem(type) {
            const dateKey = AppState.sundays[AppState.activeIdx];
            AppState.monthData[dateKey][type].push('');
            render();
            debouncedSave();
        }

        function removeItem(type, index) {
            const dateKey = AppState.sundays[AppState.activeIdx];
            AppState.monthData[dateKey][type].splice(index, 1);
            render();
            debouncedSave();
        }

        // Drag and Drop Logic
        document.addEventListener('dragstart', (e) => {
            if (e.target.draggable) {
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.target.dataset.index);
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            const over = e.target.closest('[draggable]');
            if (over) over.classList.add('drag-over');
        });

        document.addEventListener('dragleave', (e) => {
            const over = e.target.closest('[draggable]');
            if (over) over.classList.remove('drag-over');
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            const container = e.target.closest('[data-type]');
            const dragging = document.querySelector('.dragging');
            const over = e.target.closest('[draggable]');
            
            if (container && dragging && over) {
                const type = container.dataset.type;
                if (type !== 'songs') return; // Solo canciones son ordenables

                const fromIdx = parseInt(dragging.dataset.index);
                const toIdx = parseInt(over.dataset.index);
                const dateKey = AppState.sundays[AppState.activeIdx];
                
                const items = AppState.monthData[dateKey][type];
                const [movedItem] = items.splice(fromIdx, 1);
                items.splice(toIdx, 0, movedItem);
                
                render();
                debouncedSave();
            }
        });

        document.addEventListener('dragend', () => {
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        });

        // Guardado persistente
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(save, 1500);
        }

        async function save() {
            if (AppState.isSaving || !AppState.user) return;
            AppState.isSaving = true;
            
            const status = document.getElementById('syncStatus');
            status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></div> Guardando...';

            try {
                const monthKey = `2026-${AppState.currentMonth}`;
                const docRef = doc(db, 'artifacts', AppState.appId, 'public', 'data', 'months', monthKey);
                await setDoc(docRef, AppState.monthData);
                status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.4)]"></div> Online';
            } catch (error) {
                console.error("Error guardando:", error);
                status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> Error al guardar';
            } finally {
                AppState.isSaving = false;
            }
        }

        // üÜï BOT√ìN GUARDAR MANUAL
function manualSave() {
    const btn = document.getElementById('manualSaveBtn');
    const status = document.getElementById('syncStatus');
    
    btn.innerHTML = 'üü¢ Guardando...';
    btn.className = 'bg-emerald-500 text-white px-8 py-3 rounded-2xl text-sm font-black uppercase tracking-wider shadow-xl shadow-emerald-500/25 transition-all transform hover:scale-[1.02] active:scale-[0.98] animate-pulse';
    
    save().then(() => {
        btn.innerHTML = '‚úÖ ¬°Guardado!';
        status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.4)]"></div> ‚úÖ CONFIRMADO';
        
        setTimeout(() => {
            btn.innerHTML = '‚úÖ Guardado Confirmado';
            btn.className = btn.className.replace('animate-pulse', '');
        }, 2000);
    });
}

        function toggleMode() {
            AppState.viewMode = AppState.viewMode === 'view' ? 'edit' : 'view';
            document.getElementById('toggleModeBtn').innerText = AppState.viewMode === 'view' ? 'Editar' : 'Ver';
            render();
        }

        function changeMonth() {
            AppState.currentMonth = parseInt(document.getElementById('monthSelect').value);
            AppState.sundays = getSundays(AppState.currentMonth);
            AppState.activeIdx = 0;
            AppState.monthData = {};
            setupRealtimeListener();
        }

        function updateTodayLabel() {
            const hoy = new Date();
            document.getElementById('todayLabel').innerText = "Hoy: " + hoy.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        }

     async function exportImage() {
    try {
        // Cargar html2canvas si no est√°
        if (!window.html2canvas) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            document.head.appendChild(script);
            await new Promise(resolve => { script.onload = resolve; });
        }

        // Ocultar header/nav/footer para captura limpia
        const header = document.querySelector('header');
        const nav = document.querySelector('nav');
        const footer = document.querySelector('footer');
        const originalDisplay = { header: header.style.display, nav: nav.style.display, footer: footer.style.display };
        header.style.display = nav.style.display = footer.style.display = 'none';

        const content = document.getElementById('contentArea');
        const canvas = await window.html2canvas(content, {
            scale: 2,  // Alta calidad
            useCORS: true,
            backgroundColor: '#ffffff',
            width: content.scrollWidth,
            height: content.scrollHeight
        });

        // Restaurar elementos
        header.style.display = originalDisplay.header;
        nav.style.display = originalDisplay.nav;
        footer.style.display = originalDisplay.footer;

        // Descargar PNG
        const link = document.createElement('a');
        link.download = `IEBLA-Domingo-${new Date(AppState.sundays[AppState.activeIdx]).getDate()}-${monthNames[AppState.currentMonth].substring(0,3)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        console.log('Imagen generada!');
    } catch (error) {
        console.error('Error imagen:', error);
        alert('Error generando imagen. Revisa consola.');
    }
}


        // Iniciar
        init();
    </script>
</body>
</html>
