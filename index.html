<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Musical IEBLA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    button:active { transform: scale(0.97); }
    .nav-btn { -webkit-tap-highlight-color: transparent; }
    .drag-over { border: 2px dashed #3b82f6 !important; background: #eff6ff !important; }
    .dragging { opacity: 0.6; transform: scale(0.98); }
    
    /* Glassmorphism PRO */
    .glass { 
        background: rgba(255,255,255,0.15); 
        backdrop-filter: blur(24px); 
        border: 1px solid rgba(255,255,255,0.25);
    }
    .glow-cyan { box-shadow: 0 0 30px rgba(6,182,212,0.4), 0 25px 50px rgba(0,0,0,0.5); }
    .glow-purple { box-shadow: 0 0 30px rgba(168,85,247,0.4), 0 25px 50px rgba(0,0,0,0.5); }
    .glow-lime { box-shadow: 0 0 30px rgba(132,204,22,0.4), 0 25px 50px rgba(0,0,0,0.5); }
    .glow-blue { box-shadow: 0 0 30px rgba(59,130,246,0.4), 0 25px 50px rgba(0,0,0,0.5); }
    .glow-amber { box-shadow: 0 0 30px rgba(251,191,36,0.4), 0 25px 50px rgba(0,0,0,0.5); }
    .glow-emerald { box-shadow: 0 0 30px rgba(6,125,64,0.4), 0 25px 50px rgba(0,0,0,0.5); }
    .neon-glow { text-shadow: 0 0 10px currentColor; }
        .glass-white {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
}
</style>

</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen p-3 md:p-6 lg:p-8 text-white">

 <div class="max-w-4xl mx-auto glass rounded-3xl shadow-2xl overflow-hidden glow-cyan">

        <!-- HEADER PRO -->
        <header class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 p-6 md:p-8 text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 via-purple-600/10 to-emerald-600/10"></div>
            <div class="relative flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 via-purple-500 to-emerald-500 rounded-2xl flex items-center justify-center shadow-2xl shadow-blue-500/40 ring-2 ring-white/30">
                        <svg viewBox="0 0 24 24" class="w-9 h-9 text-white drop-shadow-lg" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M9 18V5l12-2v13"></path>
                            <circle cx="6" cy="18" r="3"></circle>
                            <circle cx="18" cy="16" r="3"></circle>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-black italic tracking-tight leading-none bg-gradient-to-r from-white to-slate-200 bg-clip-text text-transparent drop-shadow-lg">IEBLA</h1>
                        <p class="text-blue-300 text-sm md:text-base font-bold uppercase tracking-widest mt-1 bg-blue-400/20 px-4 py-1.5 rounded-full inline-block shadow-md">Agenda Musical 2026</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 w-full md:w-auto">
                    <select id="monthSelect" class="bg-slate-800/60 backdrop-blur-sm text-white text-sm px-6 py-3.5 rounded-2xl outline-none border border-white/30 cursor-pointer hover:bg-slate-700/90 transition-all shadow-xl shadow-black/30 hover:shadow-2xl">
                        <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                        <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                        <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                        <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                    <div class="flex gap-2">
                        <button id="exportBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-6 py-3.5 rounded-2xl text-sm font-black uppercase tracking-wider shadow-2xl shadow-green-500/40 hover:shadow-green-500/60 transition-all hidden">
                            üì± PNG
                        </button>
                        <button id="toggleModeBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-8 py-3.5 rounded-2xl text-sm font-black uppercase tracking-wider shadow-2xl shadow-blue-500/40 hover:shadow-blue-500/60 transition-all">
                            Editar
                        </button>
                    </div>
                </div>
            </div>
        </header>

   <!-- NAV COMPLETO CORREGIDO -->
<nav class="glass-white px-6 py-6 flex justify-between items-center gap-4 shadow-2xl border-b border-white/20 glow-purple">
    <!-- BOT√ìN PREV ‚úÖ -->
    <button id="prevSunday" class="w-16 h-16 glass-white hover:bg-white/30 flex items-center justify-center rounded-3xl transition-all duration-300 shadow-2xl hover:shadow-3xl text-cyan-300 hover:text-white active:scale-95 ring-2 ring-white/30 nav-btn">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
    </button>
    
    <!-- CENTRO NAV -->
    <div class="flex flex-col items-center text-center">
        <div id="syncStatus" class="flex gap-2.5 items-center text-xs font-black text-cyan-300 uppercase tracking-widest mb-3 glass-white px-4 py-2 rounded-2xl shadow-lg">
            <div class="w-2.5 h-2.5 rounded-full bg-slate-400 shadow-inner"></div> Conectando...
        </div>
        <!-- resto igual -->
    </div>

    <!-- BOT√ìN NEXT ‚úÖ -->
    <button id="nextSunday" class="w-16 h-16 glass-white hover:bg-white/30 flex items-center justify-center rounded-3xl transition-all duration-300 shadow-2xl hover:shadow-3xl text-cyan-300 hover:text-white active:scale-95 ring-2 ring-white/30 nav-btn">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
    </button>
</nav>


        <!-- CONTENIDO PRINCIPAL -->
    <main id="contentArea" class="p-8 md:p-12 lg:p-16 min-h-[500px] glass-white glow-purple">
            <div class="flex items-center justify-center h-full">
                <p class="text-slate-400 text-lg animate-pulse font-medium">Cargando agenda...</p>
            </div>
        </main>

        <!-- FOOTER PRO -->
        <footer class="bg-gradient-to-r from-slate-900 to-slate-800 text-white/95 p-8 md:p-10 text-center border-t-4 border-blue-500/30 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-emerald-500/5"></div>
            <div class="relative">
                <p id="todayLabel" class="text-sm font-black uppercase tracking-[0.5em] mb-4 bg-white/20 backdrop-blur-sm px-6 py-2 rounded-2xl inline-block shadow-2xl">Hoy</p>
                <div class="flex flex-col items-center gap-2">
                    <p class="text-3xl font-black bg-gradient-to-r from-blue-400 via-emerald-400 to-purple-400 bg-clip-text text-transparent drop-shadow-2xl">IEBLA</p>
                    <p class="text-sm font-bold uppercase tracking-widest bg-slate-700/50 px-4 py-1 rounded-full inline-block">Agenda Musical ‚Ä¢ 2026</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK v11 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // Configuraci√≥n unificada
        const firebaseConfig = {
            apiKey: "AIzaSyB4dnDnojGL8NNMSxRJFV4eVQvKUkdoKJM",
            authDomain: "agenda-iebla.firebaseapp.com",
            projectId: "agenda-iebla",
            storageBucket: "agenda-iebla.firebasestorage.app",
            messagingSenderId: "94924538907",
            appId: "1:94924538907:web:861e69bbf351973f7de4be",
            measurementId: "G-4L3GNF3SY6"
        };

        // Estado de la App
        const AppState = {
            viewMode: 'view',
            currentMonth: new Date().getMonth(),
            activeIdx: 0,
            monthData: {},
            sundays: [],
            unsubscribe: null,
            isSaving: false,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'agenda-musical-iebla-v21',
            user: null,
            musiciansList: [
                "Kevin (direcci√≥n/voz)", "Norma (direcci√≥n/voz)", "Nataly (direcci√≥n/voz)", 
                "Gabriel (bater√≠a)","Anderson (bater√≠a)", "David (bajo)", "Lore (teclado/bajo)", "Magali (teclado)", "Thiago (teclado)",
                "Pame (proyecci√≥n)", "Nico (proyecci√≥n)", "Sonia (proyecci√≥n)", "Emma (guitarra)", "Kevin (guitarra)",
                "Pedro (sonido)", "Cristian (sonido)", "Nestor (sonido)", "Ari (voz apoyo)", "Fernando (voz apoyo)", "Meli (voz apoyo)", "Iara (voz apoyo)"
            ]
        };

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        let db, auth;

        // Inicializar Firebase
        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                const cred = await signInAnonymously(auth);
                AppState.user = cred.user;
                
                setupInitialState();
                setupEventListeners();
                setupRealtimeListener();
                updateTodayLabel();
            } catch (error) {
                console.error("Error de inicializaci√≥n:", error);
                document.getElementById('contentArea').innerHTML = `<p class="text-red-500 text-center">Error al conectar: ${error.message}</p>`;
            }
        }

        function setupInitialState() {
            const hoy = new Date();
            AppState.sundays = getSundays(AppState.currentMonth);
            const hoyISO = hoy.toISOString().split('T')[0];
            
            AppState.activeIdx = AppState.sundays.findIndex(s => s >= hoyISO);

            if (AppState.activeIdx === -1) {
                if (AppState.currentMonth < 11) {
                    AppState.currentMonth++;
                    AppState.sundays = getSundays(AppState.currentMonth);
                    AppState.activeIdx = 0;
                } else {
                    AppState.activeIdx = AppState.sundays.length - 1;
                }
            }
            document.getElementById('monthSelect').value = AppState.currentMonth;
        }

        function getSundays(month) {
            const year = 2026;
            const date = new Date(year, month, 1);
            const found = [];
            while (date.getMonth() === month) {
                if (date.getDay() === 0) found.push(new Date(date).toISOString().split('T')[0]);
                date.setDate(date.getDate() + 1);
            }
            return found;
        }

        function setupEventListeners() {
            document.getElementById('prevSunday').addEventListener('click', () => {
                if (AppState.activeIdx > 0) { AppState.activeIdx--; render(); }
            });

            document.getElementById('nextSunday').addEventListener('click', () => {
                if (AppState.activeIdx < AppState.sundays.length - 1) { AppState.activeIdx++; render(); }
            });

            document.getElementById('toggleModeBtn').addEventListener('click', toggleMode);
            document.getElementById('monthSelect').addEventListener('change', changeMonth);
            document.getElementById('exportBtn').addEventListener('click', exportImage);
        }

        function setupRealtimeListener() {
            if (AppState.unsubscribe) AppState.unsubscribe();
            if (!AppState.user) return;

            const monthKey = `2026-${AppState.currentMonth}`;
            const status = document.getElementById('syncStatus');
            status.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse shadow-inner"></div> Sincronizando...';

            const docRef = doc(db, 'artifacts', AppState.appId, 'public', 'data', 'months', monthKey);

            AppState.unsubscribe = onSnapshot(docRef, 
                (snapshot) => {
                    AppState.monthData = snapshot.exists() ? snapshot.data() : {};
                    render();
                    status.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div> Online';
                },
                (error) => {
                    console.error("Error en listener:", error);
                    status.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-inner"></div> Error de red';
                }
            );
        }

        function render() {
            const dateKey = AppState.sundays[AppState.activeIdx];
            if (!dateKey) {
                document.getElementById('navDateDisplay').innerText = "-";
                return;
            };

            ensureData(dateKey);
            const data = AppState.monthData[dateKey];
            const dayNum = new Date(dateKey + "T12:00:00").getDate();

            document.getElementById('navDateDisplay').innerText = dayNum;
            document.getElementById('exportBtn').classList.toggle('hidden', AppState.viewMode !== 'view');

            const container = document.getElementById('contentArea');
            container.innerHTML = getContentHTML(data, dayNum);
        }

        function ensureData(dateKey) {
            if (!AppState.monthData[dateKey]) {
                AppState.monthData[dateKey] = { musicians: [], songs: [], notes: ''  };
            }
        }

      function getContentHTML(data, dayNum) {
    const monthLabel = monthNames[AppState.currentMonth];
    if (AppState.viewMode === 'view') {
        return `
        <div class="fade-in">
            <div class="text-center mb-12">
                <h2 class="text-6xl md:text-7xl font-black bg-gradient-to-r from-cyan-400 via-white to-purple-400 bg-clip-text text-transparent tracking-tighter mb-2 drop-shadow-2xl neon-glow">${dayNum}</h2>
                <p class="text-cyan-300 font-black uppercase tracking-[0.3em] text-lg bg-white/20 backdrop-blur-sm px-6 py-3 rounded-full inline-block shadow-lg">${monthLabel}</p>
            </div>
            <div class="space-y-8">
                <!-- M√öSICOS -->
                <div class="glass rounded-3xl p-8 glow-cyan">
                    <h3 class="text-cyan-300 font-black mb-6 flex items-center gap-3 text-lg uppercase tracking-widest neon-glow">üé∏ Equipo Musical</h3>
                    <div class="flex flex-wrap gap-3">
                        ${data.musicians.length ? data.musicians.map(m => `<span class="glass-white px-5 py-3 rounded-2xl shadow-lg text-slate-100 font-bold text-base">${m}</span>`).join('') : '<p class="text-slate-400 italic text-lg w-full text-center font-medium py-8">Sin asignar</p>'}
                    </div>
                </div>
                
                <!-- CANCIONES -->
                <div class="glass rounded-3xl p-8 glow-purple">
                    <h3 class="text-purple-300 font-black mb-6 flex items-center gap-3 text-lg uppercase tracking-widest neon-glow">üé§ Canciones</h3>
                    <ul class="space-y-3">
                        ${data.songs.length ? data.songs.map((s, i) => `<li class="glass-white p-5 rounded-2xl shadow-lg text-slate-100 font-bold text-base flex items-center gap-4"><span class="text-purple-400 text-xl font-black w-8 text-center">${i+1}</span> ${s}</li>`).join('') : '<p class="text-slate-400 italic text-lg text-center w-full font-medium py-8">Sin canciones</p>'}
                    </ul>
                </div>
                
                <!-- NOTAS -->
                <div class="glass rounded-3xl p-8 glow-lime">
                    <h3 class="text-lime-400 font-black mb-6 flex items-center gap-3 text-lg uppercase tracking-widest neon-glow">üìù Notas Predicador</h3>
                    <p class="text-slate-100 text-base leading-relaxed whitespace-pre-wrap">${data.notes || 'Sin notas'}</p>
                </div>
            </div>
        </div>`;
    } else {
        return `
        <div class="fade-in space-y-10">
            ${editSectionHTML('M√∫sicos', 'musicians', data.musicians, 'üé∏')}
            ${editSectionHTML('Canciones', 'songs', data.songs, 'üé§')}
            ${editNotesSectionHTML(data.notes || '')}
            <div id="saveSection" class="pt-12 border-t border-white/30 text-center">
                <button id="manualSaveBtn" class="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white px-14 py-6 rounded-3xl text-lg font-black uppercase tracking-widest shadow-2xl glow-lime hover:glow-lime transition-all transform hover:scale-[1.05] active:scale-[0.98] ring-4 ring-emerald-400/40">
                    ‚úÖ Guardado Confirmado
                </button>
                <p class="text-lg text-slate-400 mt-4 font-semibold backdrop-blur-sm">Datos sincronizados con Firebase en tiempo real</p>
            </div>
        </div>`;
    }
}


        function editSectionHTML(title, type, items, emoji) {
            if (type === 'musicians') {
                return `
                    <section class="glass rounded-3xl p-8 glow-blue">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-blue-800 uppercase text-lg tracking-widest flex items-center gap-3">${emoji} ${title}</h3>
                        </div>
                        <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-blue-200 max-h-80 overflow-y-auto">
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                ${AppState.musiciansList.map((musician, i) => {
                                    const checked = items.includes(musician) ? 'checked' : '';
                                    return `
                                        <label class="flex items-center gap-3 p-4 bg-white rounded-xl shadow-md border border-blue-100 hover:shadow-lg transition-all cursor-pointer group hover:bg-blue-50">
                                            <input type="checkbox" 
                                                data-musician="${musician}" 
                                                data-field="musicians"
                                                class="w-6 h-6 text-blue-600 rounded focus:ring-blue-500 shadow-sm" 
                                                ${checked}>
                                            <span class="text-base font-semibold text-slate-800 group-hover:text-blue-700">${musician}</span>
                                        </label>`;
                                }).join('')}
                            </div>
                            <p class="text-sm text-blue-600 mt-6 font-bold bg-blue-100/50 px-4 py-2 rounded-xl inline-block">
                                Seleccionados: <span id="musicianCount">${items.length}</span>/21
                            </p>
                        </div>
                    </section>`;
            } else {
                const color = type === 'songs' ? 'purple' : 'blue';
                const isDraggable = type === 'songs';
                return `
                    <section class="glass rounded-3xl p-8 glow-${color === 'purple' ? 'purple' : 'blue'}">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-${color}-800 uppercase text-lg tracking-widest flex items-center gap-3">${emoji} ${title}</h3>
                            <button id="add-${type}" class="bg-gradient-to-r from-${color}-500 to-${color}-600 text-white w-14 h-14 rounded-2xl font-black text-2xl shadow-2xl shadow-${color}-500/50 hover:shadow-${color}-500/70 transition-all active:scale-95 hover:from-${color}-600 hover:to-${color}-700">+</button>
                        </div>
                        <div class="space-y-3 bg-white/60 backdrop-blur-sm rounded-2xl p-6 border border-${color}-200" id="list-${type}" data-type="${type}">
                            ${items.map((item, i) => `
                                <div class="flex gap-3 group items-center p-4 bg-white/80 backdrop-blur-sm rounded-2xl border border-slate-200 hover:border-${color}-300 transition-all hover:shadow-lg ${isDraggable ? 'hover:cursor-grab' : ''}" 
                                     ${isDraggable ? `draggable="true"` : ''} data-index="${i}">
                                    ${isDraggable ? `<div class="cursor-grab text-slate-400 px-2 hover:text-slate-600 font-bold text-lg select-none">‚†ø</div>` : '<div class="w-3"></div>'}
                                    <input type="text" value="${item}" data-idx="${i}" data-field="${type}"
                                        placeholder="Escribir..." class="flex-1 p-3 bg-transparent border-none outline-none text-base font-semibold focus:font-black text-slate-800 rounded-xl">
                                    <button data-del-type="${type}" data-del-idx="${i}" class="w-12 h-12 flex items-center justify-center rounded-2xl text-slate-400 hover:text-red-500 hover:bg-red-50 transition-all group-hover:shadow-md">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </section>`;
            }
        }

        function editNotesSectionHTML(notes) {
            return `
                <section class="glass rounded-3xl p-8 glow-amber">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-amber-800 uppercase text-lg tracking-widest flex items-center gap-3">üìù Notas Predicador</h3>
                    </div>
                    <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-6 border border-amber-200">
                        <textarea data-field="notes" data-idx="0" 
                            placeholder="Mensaje principal, vers√≠culos clave, orden del culto..." 
                            class="w-full p-6 bg-white rounded-xl border border-amber-200 resize-vertical min-h-[160px] text-base font-semibold focus:font-black text-slate-800 outline-none shadow-inner">${notes}</textarea>
                    </div>
                </section>
            `;
        }

        // Delegaci√≥n de eventos para edici√≥n din√°mica
        document.addEventListener('click', (e) => {
            if (e.target.id === 'add-musicians') addItem('musicians');
            if (e.target.id === 'add-songs') addItem('songs');
            
            const delBtn = e.target.closest('[data-del-type]');
            if (delBtn) {
                const type = delBtn.dataset.delType;
                const idx = parseInt(delBtn.dataset.delIdx);
                removeItem(type, idx);
            }

            if (e.target.id === 'manualSaveBtn') save();
        });

        document.addEventListener('change', (e) => {
            if (e.target.dataset.field) {
                const field = e.target.dataset.field;
                const dateKey = AppState.sundays[AppState.activeIdx];
                
                if (field === 'notes') {
                    AppState.monthData[dateKey][field] = e.target.value;
                } else if (field === 'musicians') {
                    const checkboxes = document.querySelectorAll('input[data-field="musicians"]');
                    const selectedMusicians = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.dataset.musician);
                    AppState.monthData[dateKey][field] = selectedMusicians;
                    document.getElementById('musicianCount').textContent = selectedMusicians.length;
                } else {
                    const idx = parseInt(e.target.dataset.idx);
                    AppState.monthData[dateKey][field][idx] = e.target.value;
                }
                debouncedSave();
            }
        });

        function addItem(type) {
            const dateKey = AppState.sundays[AppState.activeIdx];
            AppState.monthData[dateKey][type].push('');
            render();
            debouncedSave();
        }

        function removeItem(type, index) {
            const dateKey = AppState.sundays[AppState.activeIdx];
            AppState.monthData[dateKey][type].splice(index, 1);
            render();
            debouncedSave();
        }

        // Drag and Drop Logic
        document.addEventListener('dragstart', (e) => {
            if (e.target.draggable) {
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.target.dataset.index);
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            const over = e.target.closest('[draggable]');
            if (over) over.classList.add('drag-over');
        });

        document.addEventListener('dragleave', (e) => {
            const over = e.target.closest('[draggable]');
            if (over) over.classList.remove('drag-over');
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            const container = e.target.closest('[data-type]');
            const dragging = document.querySelector('.dragging');
            const over = e.target.closest('[draggable]');
            
            if (container && dragging && over) {
                const type = container.dataset.type;
                if (type !== 'songs') return;

                const fromIdx = parseInt(dragging.dataset.index);
                const toIdx = parseInt(over.dataset.index);
                const dateKey = AppState.sundays[AppState.activeIdx];
                
                const items = AppState.monthData[dateKey][type];
                const [movedItem] = items.splice(fromIdx, 1);
                items.splice(toIdx, 0, movedItem);
                
                render();
                debouncedSave();
            }
        });

        document.addEventListener('dragend', () => {
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        });

        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(save, 1500);
        }

        async function save() {
            if (AppState.isSaving || !AppState.user) return;
            AppState.isSaving = true;
            
            const status = document.getElementById('syncStatus');
            status.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse shadow-inner"></div> Guardando...';

            try {
                const monthKey = `2026-${AppState.currentMonth}`;
                const docRef = doc(db, 'artifacts', AppState.appId, 'public', 'data', 'months', monthKey);
                await setDoc(docRef, AppState.monthData);
                status.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div> Online';
            } catch (error) {
                console.error("Error guardando:", error);
                status.innerHTML = '<div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-inner"></div> Error al guardar';
            } finally {
                AppState.isSaving = false;
            }
        }

        function toggleMode() {
            AppState.viewMode = AppState.viewMode === 'view' ? 'edit' : 'view';
            document.getElementById('toggleModeBtn').innerText = AppState.viewMode === 'view' ? 'Editar' : 'Ver';
            render();
        }

        function changeMonth() {
            AppState.currentMonth = parseInt(document.getElementById('monthSelect').value);
            AppState.sundays = getSundays(AppState.currentMonth);
            AppState.activeIdx = 0;
            AppState.monthData = {};
            setupRealtimeListener();
        }

        function updateTodayLabel() {
            const hoy = new Date();
            document.getElementById('todayLabel').innerText = "Hoy: " + hoy.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        async function exportImage() {
            try {
                if (!window.html2canvas) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => { script.onload = resolve; });
                }

                const header = document.querySelector('header');
                const nav = document.querySelector('nav');
                const footer = document.querySelector('footer');
                const originalDisplay = { header: header.style.display, nav: nav.style.display, footer: footer.style.display };
                header.style.display = nav.style.display = footer.style.display = 'none';

                const content = document.getElementById('contentArea');
                const canvas = await window.html2canvas(content, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: content.scrollWidth,
                    height: content.scrollHeight
                });

                header.style.display = originalDisplay.header;
                nav.style.display = originalDisplay.nav;
                footer.style.display = originalDisplay.footer;

                const link = document.createElement('a');
                link.download = `IEBLA-Domingo-${new Date(AppState.sundays[AppState.activeIdx]).getDate()}-${monthNames[AppState.currentMonth].substring(0,3)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                console.log('Imagen generada!');
            } catch (error) {
                console.error('Error imagen:', error);
                alert('Error generando imagen. Revisa consola.');
            }
        }

        init();
    </script>
</body>
</html>
