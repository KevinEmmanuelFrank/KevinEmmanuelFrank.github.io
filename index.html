<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Musical IEBLA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        button:active { transform: scale(0.95); }
        .nav-btn { -webkit-tap-highlight-color: transparent; }
        .drag-over { border: 2px dashed #3b82f6 !important; background: #eff6ff !important; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-2 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-200">
        
        <!-- HEADER -->
        <header class="bg-slate-900 p-5 md:p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center shrink-0 shadow-lg shadow-blue-500/20">
                    <svg viewBox="0 0 24 24" class="w-7 h-7 text-white" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18V5l12-2v13"></path>
                        <circle cx="6" cy="18" r="3"></circle>
                        <circle cx="18" cy="16" r="3"></circle>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter leading-none">IEBLA</h1>
                    <p class="text-blue-400 text-[9px] uppercase tracking-[0.2em] font-bold mt-1">Agenda Musical</p>
                </div>
            </div>

            <div class="flex items-center gap-2 w-full md:w-auto">
                <select id="monthSelect" class="flex-1 md:flex-none bg-slate-800 text-white text-xs px-4 py-2.5 rounded-xl outline-none border-none cursor-pointer hover:bg-slate-700 transition-colors">
                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                    <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                    <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                    <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                </select>
                
                <div class="flex gap-2">
                    <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-green-900/40 hidden">
                        PDF
                    </button>
                    <button id="toggleModeBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-blue-900/40">
                        Editar
                    </button>
                </div>
            </div>
        </header>

        <!-- NAVEGACIÃ“N -->
        <nav class="bg-white border-b border-slate-100 px-4 py-4 flex justify-between items-center gap-2">
            <button id="prevSunday" class="nav-btn w-12 h-12 flex items-center justify-center bg-slate-50 hover:bg-slate-100 rounded-2xl transition-colors text-slate-400 active:text-blue-600 shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
            </button>
            
            <div class="flex flex-col items-center flex-1">
                <div id="syncStatus" class="flex gap-1.5 items-center text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.4)]"></div> Online
                </div>
                <div class="flex items-baseline gap-1">
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Dom</span>
                    <span id="navDateDisplay" class="text-3xl font-black tabular-nums text-slate-900 leading-none">-</span>
                </div>
            </div>

            <button id="nextSunday" class="nav-btn w-12 h-12 flex items-center justify-center bg-slate-50 hover:bg-slate-100 rounded-2xl transition-colors text-slate-400 active:text-blue-600 shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
            </button>
        </nav>

        <!-- CONTENIDO PRINCIPAL -->
        <main id="contentArea" class="p-5 md:p-12 min-h-[400px] bg-white">
            <!-- Render dinÃ¡mico -->
        </main>

        <footer class="bg-slate-50 border-t border-slate-100 p-6 text-center">
            <p id="todayLabel" class="text-[9px] text-slate-400 font-bold uppercase tracking-[0.3em] mb-1"></p>
            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-[0.3em]">IEBLA â€¢ 2026</p>
        </footer>
    </div>

    <script>
        // 1. ESTADO CENTRALIZADO
        const AppState = {
            viewMode: 'view',
            currentMonth: new Date().getMonth(),
            activeIdx: 0,
            monthData: {},
            sundays: [],
            unsubscribe: null,
            isSaving: false,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'agenda-musical-iebla-v21'
        };

        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        let db, auth;

        // 2. INICIALIZACIÃ“N
        async function init() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }

                setupInitialState();
                setupEventListeners();
                setupRealtimeListener();
                updateTodayLabel();
            } catch (e) {
                console.error("Error init:", e);
                document.getElementById('contentArea').innerHTML = `<p class="text-red-500 p-4">Error al conectar con el servidor.</p>`;
            }
        }

        function setupInitialState() {
            const hoy = new Date();
            AppState.sundays = getSundays(AppState.currentMonth);
            const hoyISO = hoy.toISOString().split('T')[0];
            AppState.activeIdx = AppState.sundays.findIndex(s => s >= hoyISO);

            if (AppState.activeIdx === -1) {
                AppState.currentMonth = (AppState.currentMonth + 1) % 12;
                AppState.sundays = getSundays(AppState.currentMonth);
                AppState.activeIdx = 0;
            }
            document.getElementById('monthSelect').value = AppState.currentMonth;
        }

        function getSundays(month) {
            const year = 2026;
            const date = new Date(year, month, 1);
            const found = [];
            while (date.getMonth() === month) {
                if (date.getDay() === 0) found.push(new Date(date).toISOString().split('T')[0]);
                date.setDate(date.getDate() + 1);
            }
            return found;
        }

        // 3. EVENT LISTENERS
        function setupEventListeners() {
            document.getElementById('prevSunday').addEventListener('click', () => {
                if (AppState.activeIdx > 0) { AppState.activeIdx--; render(); }
            });

            document.getElementById('nextSunday').addEventListener('click', () => {
                if (AppState.activeIdx < AppState.sundays.length - 1) { AppState.activeIdx++; render(); }
            });

            document.getElementById('toggleModeBtn').addEventListener('click', toggleMode);
            document.getElementById('monthSelect').addEventListener('change', changeMonth);
            document.getElementById('exportBtn').addEventListener('click', exportPDF);
        }

        function setupRealtimeListener() {
            if (AppState.unsubscribe) AppState.unsubscribe();
            const monthKey = `2026-${AppState.currentMonth}`;
            
            const status = document.getElementById('syncStatus');
            status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></div>';

            AppState.unsubscribe = db.collection('artifacts').doc(AppState.appId)
                .collection('public').doc('data')
                .collection('months').doc(monthKey).onSnapshot(
                    (doc) => {
                        AppState.monthData = doc.exists() ? doc.data() : {};
                        render();
                        status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.4)]"></div> Online';
                    },
                    (error) => { 
                        console.error("Error listening:", error);
                        status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> Offline';
                    }
                );
        }

        // 4. RENDERIZADO
        function render() {
            const dateKey = AppState.sundays[AppState.activeIdx];
            if (!dateKey) {
                document.getElementById('navDateDisplay').innerText = "-";
                return;
            };

            ensureData(dateKey);
            const data = AppState.monthData[dateKey];
            const dayNum = new Date(dateKey + "T12:00:00").getDate();

            document.getElementById('navDateDisplay').innerText = dayNum;
            document.getElementById('exportBtn').classList.toggle('hidden', AppState.viewMode !== 'view');

            const container = document.getElementById('contentArea');
            container.innerHTML = getContentHTML(data, dayNum);
        }

        function ensureData(dateKey) {
            if (!AppState.monthData[dateKey]) {
                AppState.monthData[dateKey] = { musicians: [], songs: [] };
            }
        }

        function getContentHTML(data, dayNum) {
            const monthLabel = monthNames[AppState.currentMonth];
            if (AppState.viewMode === 'view') {
                return `
                <div class="fade-in">
                    <div class="text-center mb-10">
                        <h2 class="text-5xl font-black text-slate-900 tracking-tighter mb-1">${dayNum}</h2>
                        <p class="text-blue-600 font-bold uppercase tracking-widest text-xs">${monthLabel}</p>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-blue-50/50 rounded-3xl p-6 border border-blue-100">
                            <h3 class="text-blue-800 font-black mb-4 flex items-center gap-2 text-xs uppercase tracking-widest">ðŸŽ¸ Equipo Musical</h3>
                            <div class="flex flex-wrap gap-2">
                                ${data.musicians.length ? data.musicians.map(m => `<span class="bg-white px-4 py-2 rounded-xl shadow-sm border border-blue-100 text-slate-700 font-bold text-sm">${m}</span>`).join('') : '<p class="text-slate-400 italic text-xs w-full text-center">Sin asignar</p>'}
                            </div>
                        </div>
                        <div class="bg-purple-50/50 rounded-3xl p-6 border border-purple-100">
                            <h3 class="text-purple-800 font-black mb-4 flex items-center gap-2 text-xs uppercase tracking-widest">ðŸŽ¤ Canciones</h3>
                            <ul class="space-y-2">
                                ${data.songs.length ? data.songs.map((s, i) => `<li class="bg-white p-4 rounded-xl shadow-sm border border-purple-100 text-slate-700 font-bold text-sm flex items-center gap-3"><span class="text-purple-300 italic text-[10px]">${i+1}</span> ${s}</li>`).join('') : '<p class="text-slate-400 italic text-xs text-center w-full">Sin canciones</p>'}
                            </ul>
                        </div>
                    </div>
                </div>`;
            } else {
                return `
                <div class="fade-in space-y-8">
                    ${editSectionHTML('MÃºsicos', 'musicians', data.musicians, 'ðŸŽ¸')}
                    ${editSectionHTML('Canciones', 'songs', data.songs, 'ðŸŽ¤')}
                </div>`;
            }
        }

        function editSectionHTML(title, type, items, emoji) {
            const color = type === 'musicians' ? 'blue' : 'purple';
            const isDraggable = type === 'songs'; 
            
            return `
                <section>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-slate-800 uppercase text-[10px] tracking-widest flex items-center gap-2">${emoji} ${title}</h3>
                        <button onclick="addItem('${type}')" class="bg-${color}-600 text-white w-10 h-10 rounded-xl font-bold text-lg shadow-lg transition-all active:scale-95 hover:bg-${color}-700">+</button>
                    </div>
                    <div class="space-y-2" data-type="${type}">
                        ${items.map((item, i) => {
                            const dragAttrs = isDraggable ? 
                                `draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragend="handleDragEnd(event)"` 
                                : '';
                            const dragHandle = isDraggable ? 
                                `<div class="cursor-grab text-slate-300 px-1 hover:text-slate-500">â ¿</div>` 
                                : `<div class="w-2"></div>`;

                            return `
                            <div class="flex gap-2 group items-center p-2 bg-slate-50 rounded-xl border border-slate-200 hover:border-${color}-300 transition-all focus-within:border-${color}-500 focus-within:ring-2 focus-within:ring-${color}-100" ${dragAttrs} data-index="${i}">
                                ${dragHandle}
                                <input type="text" value="${item}" 
                                    oninput="handleInput('${type}', ${i}, this)" 
                                    placeholder="Escribir..." 
                                    id="input-${type}-${i}"
                                    class="flex-1 p-2 bg-transparent border-none outline-none text-sm font-medium focus:font-bold text-slate-700">
                                
                                <button id="tick-${type}-${i}" onclick="confirmItem('${type}', ${i})" class="w-8 h-8 flex items-center justify-center rounded-lg text-green-500 hover:bg-green-100 hover:text-green-700 transition-colors hidden" title="Confirmar cambio">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                                </button>

                                <button onclick="removeItem('${type}', ${i})" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>`;
                        }).join('')}
                    </div>
                </section>`;
        }

        // 5. ACCIONES
        function addItem(type) {
            const dateKey = AppState.sundays[AppState.activeIdx];
            AppState.monthData[dateKey][type].push('');
            render();
            debouncedSave();
            
            setTimeout(() => {
                const inputs = document.querySelectorAll(`[data-type="${type}"] input`);
                if(inputs.length) inputs[inputs.length - 1].focus();
            }, 100);
        }

        function removeItem(type, index) {
            const dateKey = AppState.sundays[AppState.activeIdx];
            AppState.monthData[dateKey][type].splice(index, 1);
            render();
            debouncedSave();
        }

        function handleInput(type, index, el) {
            updateItemValue(type, index, el.value);
            const tickBtn = document.getElementById(`tick-${type}-${index}`);
            if (tickBtn) tickBtn.classList.remove('hidden');
        }

        function updateItemValue(type, index, value) {
            const dateKey = AppState.sundays[AppState.activeIdx];
            AppState.monthData[dateKey][type][index] = value;
            debouncedSave(); 
        }

        function confirmItem(type, index) {
            const inputEl = document.getElementById(`input-${type}-${index}`);
            const tickBtn = document.getElementById(`tick-${type}-${index}`);
            
            if (inputEl) {
                const val = inputEl.value;
                const dateKey = AppState.sundays[AppState.activeIdx];
                AppState.monthData[dateKey][type][index] = val;
                
                save();
                
                if (tickBtn) tickBtn.classList.add('hidden');
                
                inputEl.parentElement.classList.add('bg-green-50', 'border-green-300');
                setTimeout(() => {
                    inputEl.parentElement.classList.remove('bg-green-50', 'border-green-300');
                }, 500);
            }
        }

        let draggedIdx = null;
        function handleDragStart(e) {
            draggedIdx = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
        }
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        function handleDrop(e) {
            e.preventDefault();
            const type = e.currentTarget.parentNode.dataset.type;
            if(type === 'musicians') return;

            const dropIdx = parseInt(e.currentTarget.dataset.index);
            const dateKey = AppState.sundays[AppState.activeIdx];
            
            const item = AppState.monthData[dateKey][type].splice(draggedIdx, 1)[0];
            AppState.monthData[dateKey][type].splice(dropIdx, 0, item);
            render();
            debouncedSave();
        }
        function handleDragEnd(e) {
            document.querySelectorAll('.drag-over').forEach(i => i.classList.remove('drag-over'));
            document.querySelectorAll('.dragging').forEach(i => i.classList.remove('dragging'));
        }

        // 6. GUARDADO & UTILIDADES
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(save, 800);
        }

        async function save() {
            if (AppState.isSaving) return;
            AppState.isSaving = true;
            const status = document.getElementById('syncStatus');
            status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></div>';

            try {
                const monthKey = `2026-${AppState.currentMonth}`;
                await db.collection('artifacts').doc(AppState.appId)
                    .collection('public').doc('data')
                    .collection('months').doc(monthKey).set(AppState.monthData);
                status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.4)]"></div> Online';
            } catch (error) {
                console.error("Error saving:", error);
                status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> Error';
            } finally { 
                AppState.isSaving = false; 
                setTimeout(() => {
                     if(!AppState.isSaving) status.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.4)]"></div> Online';
                }, 500);
            }
        }

        function toggleMode() {
            AppState.viewMode = AppState.viewMode === 'view' ? 'edit' : 'view';
            document.getElementById('toggleModeBtn').innerText = AppState.viewMode === 'view' ? 'Editar' : 'Ver';
            render();
        }

        function changeMonth() {
            AppState.currentMonth = parseInt(document.getElementById('monthSelect').value);
            AppState.sundays = getSundays(AppState.currentMonth);
            AppState.activeIdx = 0;
            AppState.monthData = {};
            render();
            setupRealtimeListener();
        }

        function updateTodayLabel() {
            const hoy = new Date();
            document.getElementById('todayLabel').innerText = "Hoy: " + hoy.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        async function exportPDF() {
            const { jsPDF } = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
            const doc = new jsPDF();
            const dateKey = AppState.sundays[AppState.activeIdx];
            const data = AppState.monthData[dateKey];
            const dayNum = new Date(dateKey + "T12:00:00").getDate();
            
            doc.setFont('helvetica', 'bold');
            doc.text(`IEBLA - Domingo ${dayNum} de ${monthNames[AppState.currentMonth]}`, 20, 20);
            
            doc.setFontSize(14);
            doc.text('EQUIPO MUSICAL:', 20, 40);
            doc.setFont('helvetica', 'normal');
            data.musicians.forEach((m, i) => doc.text(`- ${m}`, 25, 50 + i*8));
            
            const nextY = 60 + data.musicians.length * 8;
            doc.setFont('helvetica', 'bold');
            doc.text('CANCIONES:', 20, nextY);
            doc.setFont('helvetica', 'normal');
            data.songs.forEach((s, i) => doc.text(`${i+1}. ${s}`, 25, (nextY + 10) + i*8));
            
            doc.save(`Agenda-IEBLA-${dayNum}-${AppState.currentMonth + 1}.pdf`);
        }

        window.onload = init;
    </script>
</body>
</html>
